<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style type="text/css">
        html,body{
            height: 100%;
            width: 100%;
        }
        .canvas {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
<div class="canvas" id="canvasDiv">
    <canvas id="onlineSeatZone" width="414" height="581"></canvas>
</div>

<script src="static/js/vendor/zepto.js"></script>
<script src="http://m.damai.cn/vendor/zepto/event.js"></script>
<script src="http://m.damai.cn/vendor/zepto/touch.js"></script>
<script type="application/javascript">

    // 	0：空，1：可售，2：锁定，3：选中（网页用）
    var seat_states = [
        {state: false, color: 'ffffff', img_id: 0},
        {state: true, color: 'ff0000', img_id: 1},
        {state: false, color: 'ff0000', img_id: 2},
        {state: true, color: 'ff0000', img_id: 3}
    ];

    (function () {
        var root = this;
        var TouchCanvas = function (options) {
            if (!options || !options.canvas) {
                throw '参数不正确或参数错误';
            }
            this.canvas = options.canvas;
            this.canvas.width = !options.width ? this.canvas.clientWidth : options.width;
            this.canvas.height = !options.height ? this.canvas.clientHeight : options.height;
            this.context = this.canvas.getContext('2d');

            this.position = { x: 0, y: 0 };
            this.scale = { x: 0.5, y: 0.5 };
            this.lastZoomScale = null;
            this.lastX = null;
            this.lastY = null;
            this.init = false;
            this.isAnimate = false;//是否处于拖放或移动中，如果处于动画中则点击事件无效
            //数据
            this.area_list = !options.area_list ? [] : options.area_list;
            this.image_list = !options.image_list? [] : options.image_list;

            this.select_index_callback = options.select_index_callback;

            this.bg_img = options.bg_img;
            if(this.bg_img){
                var bg_image = new Image();
                bg_image.onerror = function () {
                    alert("座位图加载失败！");
                };
                bg_image.onload = (function(){
                    this.offCanvas = document.createElement('canvas');
                    if (bg_image.width && bg_image.height) {
                        this.offCanvas.width =  bg_image.width > options.boxMaxWidth ? bg_image.width: options.boxMaxWidth;
                        this.offCanvas.height = bg_image.height > options.boxMaxHeight ? bg_image.height: options.boxMaxHeight;
                    }
                    this.offContext = this.offCanvas.getContext('2d');
                    this.offContext.clearRect(0, 0, this.offCanvas.width, this.offCanvas.height);
                    this.offContext.drawImage(bg_image, 0, 0, this.offCanvas.width, this.offCanvas.height);
                    DrawArea(this.offContext, this.area_list, this.image_list);
                }).bind(this);
                bg_image.src = this.bg_img;

            }else{
                this.offCanvas = document.createElement('canvas');
                this.offCanvas.width = options.boxMaxWidth;
                this.offCanvas.height = options.boxMaxHeight;
                this.offContext = this.offCanvas.getContext('2d');
                this.offContext.clearRect(0, 0, options.boxMaxWidth, options.boxMaxHeight);
                DrawArea(this.offContext, this.area_list, this.image_list);
            }

            this.checkRequestAnimationFrame();
            requestAnimationFrame(this.animate.bind(this));
            this.setEventListeners();
        };

        var DrawArea = function(canvasContext, area_list, image_list) {
            for (var j = 0, pj = area_list.length; j < pj; j++)
            {
                var area = area_list[j];
                canvasContext.beginPath();
                if(area.img_id == -1) {
                    var points = area.points;
                    for (var r = 0, ar = points.length; r < ar; r++) {
                        canvasContext.lineTo(points[r].x, points[r].y);
                        canvasContext.fillStyle = ColorStrtoRGB(area.color);
                    }
                }else{
                    var pos_x = area.points[0].x;
                    var pos_y = area.points[0].y;
                    var width = 20;
                    var height = 20;
                    canvasContext.clearRect(pos_x, pos_y, width, height);
                    canvasContext.fillStyle = ColorStrtoRGB(area.color);
                    canvasContext.fillRect(pos_x, pos_y, width, height);
                    canvasContext.drawImage(image_list[area.img_id], area.points[0].x, area.points[0].y, 20, 20);
                }
                canvasContext.fill();
                canvasContext.closePath();
            }
        };


        TouchCanvas.prototype = {
            animate: function () {
                if (!this.init) {

                    if (this.offCanvas && this.offCanvas.width) {
                        var scaleRatio = null;
                        if (this.canvas.clientWidth > this.canvas.clientHeight) {
                            scaleRatio = this.canvas.clientWidth / this.offCanvas.width;
                        }
                        else {
                            scaleRatio = this.canvas.clientHeight / this.offCanvas.height;
                        }
                        this.scale.x = scaleRatio;
                        this.position.x = (this.canvas.clientWidth - this.offCanvas.width * this.scale.x) / 2;
                        this.scale.y = scaleRatio;
                        this.position.y = (this.canvas.clientHeight - this.offCanvas.height * this.scale.y) / 2;
                        this.init = true;
                    }
                }
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.offCanvas && this.context.drawImage(
                        this.offCanvas,
                        this.position.x, this.position.y,
                        this.scale.x * this.offCanvas.width,
                        this.scale.y * this.offCanvas.height);

                requestAnimationFrame(this.animate.bind(this));
            },


            gesturePinchZoom: function (event) {
                var zoom = false;
                if (event.targetTouches.length >= 2) {
                    var p1 = event.targetTouches[0];
                    var p2 = event.targetTouches[1];
                    var zoomScale = Math.sqrt(Math.pow(p2.pageX - p1.pageX, 2) + Math.pow(p2.pageY - p1.pageY, 2));

                    if (this.lastZoomScale) {
                        zoom = zoomScale - this.lastZoomScale;
                    }

                    this.lastZoomScale = zoomScale;
                }
                return zoom;
            },
            //缩放
            doZoom: function (zoom) {
                if (!zoom) return;

                var currentScale = this.scale.x;
                var newScale = this.scale.x + zoom / 75;

                var deltaScale = newScale - currentScale;
                var currentWidth = (this.offCanvas.width * this.scale.x);
                var currentHeight = (this.offCanvas.height * this.scale.y);
                var deltaWidth = this.offCanvas.width * deltaScale;
                var deltaHeight = this.offCanvas.height * deltaScale;

                var canvasmiddleX = this.canvas.clientWidth / 2;
                var canvasmiddleY = this.canvas.clientHeight / 2;
                var xonmap = (-this.position.x) + canvasmiddleX;
                var yonmap = (-this.position.y) + canvasmiddleY;
                var coefX = -xonmap / (currentWidth);
                var coefY = -yonmap / (currentHeight);
                var newPosX = this.position.x + deltaWidth * coefX;
                var newPosY = this.position.y + deltaHeight * coefY;

                var newWidth = currentWidth + deltaWidth;
                var newHeight = currentHeight + deltaHeight;

                if (newWidth < this.canvas.clientWidth) return;
                if (newPosX > 0) { newPosX = 0; }
                if (newPosX + newWidth < this.canvas.clientWidth) { newPosX = this.canvas.clientWidth - newWidth; }

                if (newHeight < this.canvas.clientHeight) return;
                if (newPosY > 0) { newPosY = 0; }
                if (newPosY + newHeight < this.canvas.clientHeight) { newPosY = this.canvas.clientHeight - newHeight; }

                this.scale.x = newScale;
                this.scale.y = newScale;
                this.position.x = newPosX;
                this.position.y = newPosY;
            },
            //移动
            doMove: function (relativeX, relativeY) {
                if (this.lastX && this.lastY) {
                    var maxX = this.canvas.clientWidth / 3;
                    var maxY = this.canvas.clientHeight / 3;//最多允许拖出宽高1/3
                    var deltaX = relativeX - this.lastX;
                    var deltaY = relativeY - this.lastY;
                    var currentWidth = (this.offCanvas.width * this.scale.x);
                    var currentHeight = (this.offCanvas.height * this.scale.y);

                    this.position.x += deltaX;
                    this.position.y += deltaY;

                    if (this.position.x > maxX) {
                        this.position.x = maxX;
                    }
                    else if (this.position.x + currentWidth + maxX < this.canvas.clientWidth) {
                        this.position.x = this.canvas.clientWidth - currentWidth - maxX;
                    }
                    if (this.position.y > maxY) {
                        this.position.y = maxY;
                    }
                    else if (this.position.y + currentHeight + maxY < this.canvas.clientHeight) {
                        this.position.y = this.canvas.clientHeight - currentHeight - maxY;
                    }
                }

                this.lastX = relativeX;
                this.lastY = relativeY;
            },

            setEventListeners: function () {
                // touch event
                this.canvas.addEventListener('touchstart', function (e) {
                    e.preventDefault();
                    this.lastX = null;
                    this.lastY = null;
                    this.lastZoomScale = null;
                }.bind(this));

                this.canvas.addEventListener('touchmove', function (e) {
                    e.preventDefault();

                    if (e.targetTouches.length == 2) {
                        this.isAnimate = true;
                        this.doZoom(this.gesturePinchZoom(e));
                    }
                    else if (e.targetTouches.length == 1) {
                        this.isAnimate = true;
                        var relativeX = e.targetTouches[0].pageX - this.canvas.getBoundingClientRect().left;
                        var relativeY = e.targetTouches[0].pageY - this.canvas.getBoundingClientRect().top;
                        this.doMove(relativeX, relativeY);
                    }
                }.bind(this));

                this.canvas.addEventListener('touchend', function (e) {
                    e.preventDefault();
                    if (e.changedTouches.length == 1 && !this.isAnimate) {
                        if (this.area_list==null||this.area_list.length == 0) { return; }//没有数据
                        var touch = event.changedTouches[0];
                        var relativeX = touch.pageX - this.canvas.getBoundingClientRect().left;
                        var relativeY = touch.pageY - this.canvas.getBoundingClientRect().top;
                        var pt = {
                            x: relativeX - this.position.x,
                            y: relativeY - this.position.y
                        };
                        var selected_item = null;
                        var selected_index = 0 ;
                        for (var n = 0, ln = this.area_list.length; n < ln; n++) {
                            var area = this.area_list[n];
                            if (!area.state) {
                                //跳出已经不需要验证的数据
                                continue;
                            }

                            var poly = area.points;
                            if (poly == null || poly.length == 0) {
                                //没有坐标数据
                                break;
                            }

                            var c = this.rayCasting(pt, poly, this.scale);
                            if (c != "out") {
                                selected_item = area;
                                selected_index = n;
                                break;
                            }
                        }
                        if (selected_item != null) {
                            var new_item = this.select_index_callback(selected_item);
                            if(new_item){
                                if(selected_item.img_id > -1) {
                                    this.area_list[selected_index] = new_item;
                                    this.offContext.beginPath();
                                    var points = new_item.points;
                                    var pos_x = points[0].x;
                                    var pos_y = points[0].y;
                                    var width = 20;
                                    var height = 20;
                                    this.offContext.clearRect(pos_x, pos_y, width, height);
                                    this.offContext.fillStyle = ColorStrtoRGB(new_item.color);
                                    this.offContext.fillRect(pos_x, pos_y, width, height);
                                    this.offContext.drawImage(this.image_list[new_item.img_id], points[0].x, points[0].y, width, height);
                                    this.offContext.closePath();
                                }
                            }
                        }
                    }
                    if (e.targetTouches.length == 0) {
                        this.isAnimate = false;
                    }
                }.bind(this));

            },

            checkRequestAnimationFrame: function () {
                var lastTime = 0;
                var vendors = ['ms', 'moz', 'webkit', 'o'];
                for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                    window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
                    window.cancelAnimationFrame =
                            window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame'];
                }

                if (!window.requestAnimationFrame) {
                    window.requestAnimationFrame = function (callback, element) {
                        var currTime = new Date().getTime();
                        var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                        var id = window.setTimeout(function () { callback(currTime + timeToCall); },
                                timeToCall);
                        lastTime = currTime + timeToCall;
                        return id;
                    };
                }

                if (!window.cancelAnimationFrame) {
                    window.cancelAnimationFrame = function (id) {
                        clearTimeout(id);
                    };
                }
            },
            rayCasting: function (p, poly, scale) {
                var px = p.x,
                        py = p.y,
                        flag = false;
                for (var i = 0, l = poly.length, j = l - 1; i < l; j = i, i++) {
                    var sx = poly[i].x * scale.x,
                            sy = poly[i].y * scale.y,
                            tx = poly[j].x * scale.x,
                            ty = poly[j].y * scale.y;

                    // 点与多边形顶点重合
                    if ((sx === px && sy === py) || (tx === px && ty === py)) {
                        return 'on';
                    }
                    // 判断线段两端点是否在射线两侧
                    if ((sy < py && ty >= py) || (sy >= py && ty < py)) {
                        // 线段上与射线 Y 坐标相同的点的 X 坐标
                        var x = sx + (py - sy) * (tx - sx) / (ty - sy);
                        // 点在多边形的边上
                        if (x === px) {
                            return 'on';
                        }
                        // 射线穿过多边形的边界
                        if (x > px) {
                            flag = !flag;
                        }
                    }
                }
                // 射线穿过多边形边界的次数为奇数时点在多边形内
                return flag ? 'in' : 'out';
            }
        };

        root.TouchCanvas = TouchCanvas;
    }).call(this);

</script>

<script type="application/javascript">

    var doc = document, win = window;
    var touchCanvas = null;
    var ColorStrtoRGB = function (col) {
        var r = col[0] + col[1];
        var g = col[2] + col[3];
        var b = col[4] + col[5];
        return 'rgba(' + parseInt(r, 16).toString(10) + "," + parseInt(g, 16).toString(10) + "," + parseInt(b, 16).toString(10) + ",0.55)";
    };

    var load_canvas_data = function(canvas_dom_id, bg_img, image_list, area_list, select_index_callback){
        if (touchCanvas) {
            //销毁对象
            if (touchCanvas.area_list) {
                touchCanvas.area_list = null;
            }
            win.cancelAnimationFrame(touchCanvas.animate());
            touchCanvas = null;
        }

        //初始化loading效果
        var canvas = document.getElementById(canvas_dom_id);
        var context = canvas.getContext('2d');
        var w = canvas.width = 500*2;
        var h = canvas.height = 603*2;
        var load = function (image) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, 0, 0, image.width, image.height, (w - image.width) / 2, (h - image.height) / 2, image.width, image.height);
        };
        var li = new Image();
        li.complete = function () {
            load(li);
        };
        li.onload = function () {
            load(li);
        };
        li.src = "http://dui.dmcdn.cn/damai_v2/common/img/logo.png";


        var width = 500*2;
        var height = 603*2;
        var boxMaxWidth = 0;
        var boxMaxHeight = 0;

        for (var i = 0, ai = area_list.length; i < ai; i++) {
            var area = area_list[i];
            var x = area.points[0].x + 20 | 0;
            var y = area.points[0].y + 20 | 0;
            boxMaxWidth = x > boxMaxWidth ? x : boxMaxWidth;
            boxMaxHeight = y > boxMaxHeight ? y : boxMaxHeight;
        }
        touchCanvas = new TouchCanvas({
            canvas: document.getElementById(canvas_dom_id),
            width: width,
            height: height,
            boxMaxWidth: boxMaxWidth,
            boxMaxHeight: boxMaxHeight,
            area_list: area_list,
            image_list: image_list,
            bg_img: bg_img,
            select_index_callback: select_index_callback
        });
    };

    var load_seat_data = function(canvas_dom_id, image_list, area_list){
        load_canvas_data(canvas_dom_id, undefined, image_list, area_list, function(item){
            var select_state = seat_states[3];
            if(item.img_id == 3) {
                select_state = seat_states[1];
                item.state = select_state.state;
                item.img_id = select_state.img_id;
                item.color = select_state.color;
                console.log(item);
                return item
            }
            item.state = select_state.state;
            item.img_id = select_state.img_id;
            item.color = select_state.color;
            console.log(item);
            console.log(item.seat_row + '排' + item.seat_no + '座');
            return item;
        });
    };

    var load_area_data = function(canvas_dom_id, area_list, bg_img){
        load_canvas_data(canvas_dom_id, bg_img, [], area_list, function(item){
            enter_area(item);
        });
    };


    var get_area_list = function() {
        var id = 1;
        var area_list = [];

        // 	0：空，1：可售，2：锁定，3：选中（网页用）
        for (var i = 0; i < 50; i++) {
            for (var j = 0; j < 10; j++) {
                var seat_state = seat_states[(i*j) % 4];
                var area ={};
                area['id'] = id++;
                area['state'] = seat_state.state;
                area['img_id'] = seat_state.image;
                area['color'] = seat_state.color;
                area['points'] = [
                    {'x':i * 25,      'y': j * 25},
                    {'x':i * 25 + 20, 'y': j * 25},
                    {'x':i * 25 + 20, 'y': j * 25 + 20},
                    {'x':i * 25,      'y': j * 25 + 20}
                ];

                area_list.push(area);
            }
        }
        return area_list;
    };

    var get_seat_list = function() {
        var seat_info = {
            seat_list: [
//                {
//                    "rownum": "1",
//                    "rowid": null,
//                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "2",
//                    "rowid": null,
//                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "3",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,LK@107@A,LK@102@A,LK@99@A,LK@94@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@5@A,ZL,LK@10@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "4",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,LK@106@A,ZL,LK@98@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@4@A,ZL,LK@9@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "5",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,LK@105@A,LK@101@A,LK@97@A,LK@93@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@3@A,ZL,LK@8@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "6",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,LK@104@A,ZL,LK@96@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@2@A,ZL,LK@7@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "7",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,LK@103@A,LK@100@A,LK@95@A,LK@92@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@1@A,ZL,LK@6@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "8",
//                    "rowid": null,
//                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "9",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,LK@91@A,LK@83@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "10",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,LK@90@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "11",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,LK@89@A,LK@82@A,ZL,LK@48@A,ZL,ZL,LK@45@A,ZL,LK@44@A,ZL,ZL,LK@41@A,ZL,LK@40@A,ZL,ZL,LK@37@A,ZL,LK@36@A,ZL,ZL,LK@33@A,ZL,LK@32@A,ZL,ZL,LK@29@A,ZL,LK@28@A,ZL,ZL,LK@25@A,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "12",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@47@A,LK@46@A,ZL,ZL,ZL,LK@43@A,LK@42@A,ZL,ZL,ZL,LK@39@A,LK@38@A,ZL,ZL,ZL,LK@35@A,LK@34@A,ZL,ZL,ZL,LK@31@A,LK@30@A,ZL,ZL,ZL,LK@27@A,LK@26@A,ZL,ZL,LK@14@A,LK@18@A,LK@24@A,ZL,ZL"
//                },
//                {
//                    "rownum": "13",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,LK@88@A,LK@81@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@23@A,ZL,ZL"
//                },
//                {
//                    "rownum": "14",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,LK@87@A,ZL,ZL,LK@72@A,ZL,ZL,LK@69@A,ZL,LK@68@A,ZL,ZL,LK@65@A,ZL,LK@64@A,ZL,ZL,LK@61@A,ZL,LK@60@A,ZL,ZL,LK@57@A,ZL,LK@56@A,ZL,ZL,LK@53@A,ZL,LK@52@A,ZL,ZL,LK@49@A,ZL,LK@13@A,LK@17@A,LK@22@A,ZL,ZL"
//                },
//                {
//                    "rownum": "15",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,LK@86@A,LK@80@A,ZL,ZL,LK@71@A,LK@70@A,ZL,ZL,ZL,LK@67@A,LK@66@A,ZL,ZL,ZL,LK@63@A,LK@62@A,ZL,ZL,ZL,LK@59@A,LK@58@A,ZL,ZL,ZL,LK@55@A,LK@54@A,ZL,ZL,ZL,LK@51@A,LK@50@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "16",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,LK@85@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@12@A,LK@16@A,LK@21@A,ZL,ZL"
//                },
//                {
//                    "rownum": "17",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,LK@84@A,LK@79@A,ZL,ZL,ZL,ZL,ZL,ZL,LK@78@A,ZL,ZL,LK@77@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@76@A,LK@75@A,ZL,ZL,LK@74@A,LK@73@A,ZL,ZL,ZL,ZL,ZL,ZL,LK@20@A,ZL,ZL"
//                },
//                {
//                    "rownum": "18",
//                    "rowid": "1",
//                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@11@A,LK@15@A,LK@19@A,ZL,ZL"
//                },
//                {
//                    "rownum": "19",
//                    "rowid": null,
//                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },
//                {
//                    "rownum": "20",
//                    "rowid": null,
//                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
//                },


                {
                    "rownum": "1",
                    "rowid": null,
                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "2",
                    "rowid": null,
                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "3",
                    "rowid": "加座1",
                    "columns": "ZL,ZL,LK@29@C,LK@27@C,LK@25@C,LK@23@C,LK@21@C,LK@19@C,LK@17@C,LK@15@C,LK@13@C,ZL,ZL,LK@11@C,LK@9@C,LK@7@C,LK@5@C,LK@3@C,LK@1@C,LK@2@C,LK@4@C,LK@6@C,LK@8@C,LK@10@C,ZL,ZL,ZL,LK@12@C,LK@14@C,LK@16@C,LK@18@C,LK@20@C,LK@22@C,LK@24@C,LK@26@C,ZL,ZL"
                },
                {
                    "rownum": "4",
                    "rowid": "立位",
                    "columns": "ZL,ZL,LK@5@A,LK@3@A,LK@1@A,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,LK@2@A,LK@4@A,ZL,ZL"
                },
                {
                    "rownum": "5",
                    "rowid": "立位",
                    "columns": "ZL,ZL,LK@11@A,LK@9@A,LK@7@A,A@23@B,A@21@B,A@19@B,A@17@B,LK@15@B,LK@13@B,ZL,ZL,LK@11@B,LK@9@B,LK@7@B,LK@5@B,LK@3@B,LK@1@B,LK@2@B,LK@4@B,LK@6@B,LK@8@B,A@10@B,ZL,ZL,ZL,LK@12@B,LK@14@B,A@16@B,A@18@B,A@20@B,A@22@B,LK@6@A,LK@8@A,ZL,ZL"
                },
                {
                    "rownum": "6",
                    "rowid": "立位",
                    "columns": "ZL,ZL,LK@17@A,LK@15@A,LK@13@A,A@23@B,A@21@B,A@19@B,LK@17@B,LK@15@B,LK@13@B,ZL,ZL,LK@11@B,LK@9@B,LK@7@B,LK@5@B,LK@3@B,LK@1@B,LK@2@B,LK@4@B,LK@6@B,LK@8@B,LK@10@B,LK@12@B,ZL,ZL,LK@14@B,LK@16@B,A@18@B,A@20@B,A@22@B,A@24@B,LK@10@A,LK@12@A,ZL,ZL"
                },
                {
                    "rownum": "7",
                    "rowid": "3",
                    "columns": "ZL,ZL,ZL,ZL,ZL,A@23@B,A@21@B,A@19@B,A@17@B,LK@15@B,LK@13@B,ZL,ZL,LK@11@B,LK@9@B,LK@7@B,LK@5@B,LK@3@B,LK@1@B,LK@2@B,LK@4@B,LK@6@B,LK@8@B,A@10@B,ZL,ZL,ZL,A@12@B,A@14@B,A@16@B,A@18@B,A@20@B,A@22@B,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "8",
                    "rowid": "4",
                    "columns": "ZL,ZL,ZL,ZL,ZL,A@23@B,A@21@B,A@19@B,A@17@B,A@15@B,A@13@B,ZL,ZL,LK@11@B,LK@9@B,LK@7@B,LK@5@B,LK@3@B,LK@1@B,LK@2@B,LK@4@B,LK@6@B,LK@8@B,LK@10@B,A@12@B,ZL,ZL,A@14@B,A@16@B,A@18@B,A@20@B,A@22@B,A@24@B,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "9",
                    "rowid": "5",
                    "columns": "ZL,ZL,ZL,ZL,ZL,A@23@B,A@21@B,A@19@B,A@17@B,A@15@B,A@13@B,ZL,ZL,LK@11@B,LK@9@B,LK@7@B,LK@5@B,LK@3@B,LK@1@B,LK@2@B,LK@4@B,LK@6@B,LK@8@B,LK@10@B,ZL,ZL,ZL,A@12@B,A@14@B,A@16@B,A@18@B,A@20@B,A@22@B,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "10",
                    "rowid": "6",
                    "columns": "ZL,ZL,ZL,ZL,ZL,A@23@B,A@21@B,A@19@B,A@17@B,A@15@B,A@13@B,ZL,ZL,A@11@B,A@9@B,LK@7@B,LK@5@B,LK@3@B,LK@1@B,LK@2@B,LK@4@B,LK@6@B,LK@8@B,A@10@B,A@12@B,ZL,ZL,A@14@B,A@16@B,A@18@B,A@20@B,A@22@B,A@24@B,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "11",
                    "rowid": null,
                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "12",
                    "rowid": "加座2",
                    "columns": "ZL,ZL,ZL,ZL,ZL,LK@23@C,LK@21@C,LK@19@C,LK@17@C,LK@15@C,LK@13@C,ZL,ZL,LK@11@C,LK@9@C,LK@7@C,LK@5@C,LK@3@C,LK@1@C,LK@2@C,LK@4@C,LK@6@C,LK@8@C,LK@10@C,ZL,ZL,ZL,LK@12@C,LK@14@C,LK@16@C,LK@18@C,LK@20@C,LK@22@C,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "13",
                    "rowid": null,
                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "14",
                    "rowid": "7",
                    "columns": "ZL,ZL,ZL,ZL,ZL,A@23@B,A@21@B,A@19@B,A@17@B,A@15@B,A@13@B,ZL,ZL,A@11@B,A@9@B,A@7@B,A@5@B,A@3@B,A@1@B,A@2@B,A@4@B,A@6@B,A@8@B,A@10@B,A@12@B,ZL,ZL,A@14@B,A@16@B,A@18@B,A@20@B,A@22@B,A@24@B,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "15",
                    "rowid": "8",
                    "columns": "ZL,ZL,ZL,ZL,ZL,A@23@B,A@21@B,A@19@B,A@17@B,A@15@B,A@13@B,ZL,ZL,A@11@B,A@9@B,A@7@B,A@5@B,A@3@B,A@1@B,A@2@B,A@4@B,A@6@B,A@8@B,A@10@B,ZL,ZL,ZL,A@12@B,A@14@B,A@16@B,A@18@B,A@20@B,A@22@B,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "16",
                    "rowid": "9",
                    "columns": "ZL,ZL,ZL,ZL,ZL,A@23@B,A@21@B,A@19@B,A@17@B,A@15@B,A@13@B,ZL,ZL,A@11@B,A@9@B,A@7@B,A@5@B,A@3@B,A@1@B,A@2@B,A@4@B,A@6@B,A@8@B,A@10@B,A@12@B,ZL,ZL,A@14@B,A@16@B,A@18@B,A@20@B,A@22@B,A@24@B,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "17",
                    "rowid": "10",
                    "columns": "ZL,ZL,ZL,ZL,ZL,A@23@B,A@21@B,A@19@B,A@17@B,A@15@B,A@13@B,ZL,ZL,A@11@B,A@9@B,A@7@B,A@5@B,A@3@B,A@1@B,A@2@B,A@4@B,A@6@B,A@8@B,A@10@B,ZL,ZL,ZL,A@12@B,A@14@B,A@16@B,A@18@B,A@20@B,A@22@B,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "18",
                    "rowid": "11",
                    "columns": "ZL,ZL,ZL,ZL,ZL,A@23@B,A@21@B,A@19@B,A@17@B,A@15@B,A@13@B,ZL,ZL,A@11@B,A@9@B,A@7@B,A@5@B,A@3@B,A@1@B,A@2@B,A@4@B,A@6@B,A@8@B,A@10@B,A@12@B,ZL,ZL,A@14@B,A@16@B,A@18@B,A@20@B,A@22@B,A@24@B,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "19",
                    "rowid": null,
                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
                },
                {
                    "rownum": "20",
                    "rowid": null,
                    "columns": "ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL,ZL"
                }


            ],
            "seat_type_dict": {
                "A": {
                    "color": '#FF0000',
                    "price": "90",
                    "maxbuy": 6,
                    "disprice_list": []
                }
            }
        };

        var seat_list = seat_info.seat_list;
        var area_list = [];
        seat_list.forEach(function(seat_row){
            var y_align = 20 + parseInt(seat_row.rownum) * 25;
            var columns = seat_row.columns.split(",");
            columns.forEach(function(column, column_idx){
                var x_align = 20 + column_idx * 25;
                var seat_state = 'N';
                var seat_no = 0;
                var seat_type = '';
                if(column != 'ZL'){
                    seat_state = column.split("@")[0];
                    seat_no = column.split("@")[1];
                    seat_type = column.split("@")[2];
                }
                // 	0：空，1：可售，2：锁定，3：选中（网页用）
                var area = $.extend({}, seat_states[0]);
                if(seat_state == 'A'){
                    area = $.extend({}, seat_states[1]);
                }else if (seat_state == 'LK'){
                    area = $.extend({}, seat_states[2]);
                }
                area.seat_no = seat_no;
                area.seat_type = seat_type;
                area.seat_row = seat_row.rownum;
                area.points = [{x: x_align, y: y_align},{x: x_align+20, y: y_align},{x: x_align+20, y: y_align+20},{x: x_align, y: y_align+20}];
                area_list.push(area);
            });
        });
        return area_list;
    };

    var load_images = function(sources, callback) {
        var image_list = [];
        for (var i = 0; i < sources.length; i++){
            image_list.push(0);
        }
        var has_loaded = false;
        var check_zero = function(list) {
            return list.filter(function (item) {return item === 0;}).length == 0
        };

        sources && sources.forEach(function (src, index) {
            var img = new Image();
            img.src = src;
            if (img.complete) {
                image_list[index] = img;
                if (!has_loaded && check_zero(image_list)) {
                    has_loaded = true;
                    callback(image_list);
                    return;
                }
            }
            img.onload = function () {
                image_list[index] = img;
                if (!has_loaded && check_zero(image_list)) {
                    has_loaded = true;
                    callback(image_list);
                }
                img.onload = null;
            };
            img.onerror = function () {
                alert('资源加载失败！')
            };
        });
    };

    var enter_area = function(area){
//        var area_list = get_area_list(area);
        var area_list = get_seat_list(area);
        //0:背景, 1:可售, 2:锁定, 3:选中, 4:套票
        load_images([
            'http://m.damai.cn/images/seat/bg.png',
            'http://m.damai.cn/images/seat/sold.png',
            'http://m.damai.cn/images/seat/seat_lock@3x.png',
            'http://m.damai.cn/images/seat/selected.png',
            'http://m.damai.cn/images/seat/double.png'
        ], function(image_list){
            load_seat_data("onlineSeatZone", image_list, area_list);
        });
    };

    var gen_play_info = function(){
        var play_info = {
            "extra": "{\"area_bg\": \"http://img6.gewara.com/images/theatre/theatreroom/201508/s_6d99d7ff_14f4ac6ae4d__7adf.jpg\"}",
            "type": "seat",
            "id": 38116658,
            "desc": "2017-09-11 09:47:00"
        };

        var area_info = [{
            "row_count": "20",
            "hot_zone": "82,13 419,13 419,190 81,188",
            "drama_id": "168323482",
            "first_row": "1",
            "id": 243351987,
            "column_count": "41",
            "first_column": "1"
        },{
            "row_count": "20",
            "hot_zone": "76,261 423,264 424,465 73,465",
            "drama_id": "168323482",
            "first_row": "1",
            "id": 243351988,
            "column_count": "24",
            "first_column": "1"
        }];

        var area_list = [];
        area_info.forEach(function(area){
            var points = [];
            area.hot_zone.split(' ').forEach(function(point){
                points.push({
                    x: parseInt(point.split(',')[0]),
                    y: parseInt(point.split(',')[1])
                })
            });
            area_list.push({
                color: 'FF0000',
                state: true,
                points: points,
                img_id: -1
            });
        });

        load_area_data("onlineSeatZone", area_list, JSON.parse(play_info.extra).area_bg);

    };

//    load_area_data("onlineSeatZone", area_list, jsonData.seatimg);

    gen_play_info();

</script>

</body>
</html>