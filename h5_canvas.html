<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style type="text/css">
        html,body{
            height: 100%;
            width: 100%;
        }
        .canvas {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
<div class="canvas" id="canvasDiv">
    <canvas id="onlineSeatZone" width="414" height="581"></canvas>
</div>

<script src="static/js/vendor/zepto.js"></script>
<script src="http://m.damai.cn/vendor/zepto/event.js"></script>
<script src="http://m.damai.cn/vendor/zepto/touch.js"></script>
<script type="application/javascript">

    // 	0：空，1：可售，2：锁定，3：选中（网页用）
    var seat_states = [
        {state: false, color: 'ffffff', image: 0},
        {state: true, color: 'ff0000', image: 1},
        {state: false, color: 'ff0000', image: 2},
        {state: true, color: 'ff0000', image: 3}
    ];

    (function () {
        var root = this;
        var TouchCanvas = function (options) {
            if (!options || !options.canvas) {
                throw '参数不正确或参数错误';
            }
            this.canvas = options.canvas;
            this.canvas.width = !options.width ? this.canvas.clientWidth : options.width;
            this.canvas.height = !options.height ? this.canvas.clientHeight : options.height;
            this.context = this.canvas.getContext('2d');

            this.position = { x: 0, y: 0 };
            this.scale = { x: 0.5, y: 0.5 };
            this.lastZoomScale = null;
            this.lastX = null;
            this.lastY = null;
            this.init = false;
            this.isAnimate = false;//是否处于拖放或移动中，如果处于动画中则点击事件无效
            //数据
            this.area_list = !options.area_list ? [] : options.area_list;
            this.image_list = !options.image_list? [] : options.image_list;

            this.select_index_callback = options.select_index_callback;

            this.bg_img = options.bg_img;
            if(this.bg_img){
                var bg_image = new Image();
                bg_image.onerror = function () {
                    alert("座位图加载失败！");
                };
                bg_image.onload = (function(){
                    this.offCanvas = document.createElement('canvas');
                    if (bg_image.width && bg_image.height) {
                        this.offCanvas.width =  bg_image.width > options.boxMaxWidth ? bg_image.width: options.boxMaxWidth;
                        this.offCanvas.height = bg_image.height > options.boxMaxHeight ? bg_image.height: options.boxMaxHeight;
                    }
                    this.offContext = this.offCanvas.getContext('2d');
                    this.offContext.clearRect(0, 0, this.offCanvas.width, this.offCanvas.height);
                    this.offContext.drawImage(bg_image, 0, 0, this.offCanvas.width, this.offCanvas.height);
                    DrawArea(this.offContext, this.area_list, this.image_list);
                }).bind(this);
                bg_image.src = this.bg_img;

            }else{
                this.offCanvas = document.createElement('canvas');
                this.offCanvas.width = options.boxMaxWidth;
                this.offCanvas.height = options.boxMaxHeight;
                this.offContext = this.offCanvas.getContext('2d');
                this.offContext.clearRect(0, 0, options.boxMaxWidth, options.boxMaxHeight);
                DrawArea(this.offContext, this.area_list, this.image_list);
            }

            this.checkRequestAnimationFrame();
            requestAnimationFrame(this.animate.bind(this));
            this.setEventListeners();
        };

        var DrawArea = function(canvasContext, area_list, image_list) {
            for (var j = 0, pj = area_list.length; j < pj; j++)
            {
                var area = area_list[j];
                canvasContext.beginPath();
                if(area.img_id == -1) {
                    var points = area.points;
                    for (var r = 0, ar = points.length; r < ar; r++) {
                        canvasContext.lineTo(points[r].x, points[r].y);
                        canvasContext.fillStyle = ColorStrtoRGB(area.color);
                    }
                }else{
                    var pos_x = area.points[0].x;
                    var pos_y = area.points[0].y;
                    var width = 20;
                    var height = 20;
                    canvasContext.clearRect(pos_x, pos_y, width, height);
                    canvasContext.fillStyle = ColorStrtoRGB(area.color);
                    canvasContext.fillRect(pos_x, pos_y, width, height);
                    canvasContext.drawImage(image_list[area.img_id], area.points[0].x, area.points[0].y, 20, 20);
                }
                canvasContext.fill();
                canvasContext.closePath();
            }
        };


        TouchCanvas.prototype = {
            animate: function () {
                if (!this.init) {

                    if (this.offCanvas && this.offCanvas.width) {
                        var scaleRatio = null;
                        if (this.canvas.clientWidth > this.canvas.clientHeight) {
                            scaleRatio = this.canvas.clientWidth / this.offCanvas.width;
                        }
                        else {
                            scaleRatio = this.canvas.clientHeight / this.offCanvas.height;
                        }
                        this.scale.x = scaleRatio;
                        this.position.x = (this.canvas.clientWidth - this.offCanvas.width * this.scale.x) / 2;
                        this.scale.y = scaleRatio;
                        this.position.y = (this.canvas.clientHeight - this.offCanvas.height * this.scale.y) / 2;
                        this.init = true;
                    }
                }
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.offCanvas && this.context.drawImage(
                        this.offCanvas,
                        this.position.x, this.position.y,
                        this.scale.x * this.offCanvas.width,
                        this.scale.y * this.offCanvas.height);

                requestAnimationFrame(this.animate.bind(this));
            },


            gesturePinchZoom: function (event) {
                var zoom = false;
                if (event.targetTouches.length >= 2) {
                    var p1 = event.targetTouches[0];
                    var p2 = event.targetTouches[1];
                    var zoomScale = Math.sqrt(Math.pow(p2.pageX - p1.pageX, 2) + Math.pow(p2.pageY - p1.pageY, 2));

                    if (this.lastZoomScale) {
                        zoom = zoomScale - this.lastZoomScale;
                    }

                    this.lastZoomScale = zoomScale;
                }
                return zoom;
            },
            //缩放
            doZoom: function (zoom) {
                if (!zoom) return;

                var currentScale = this.scale.x;
                var newScale = this.scale.x + zoom / 75;

                var deltaScale = newScale - currentScale;
                var currentWidth = (this.offCanvas.width * this.scale.x);
                var currentHeight = (this.offCanvas.height * this.scale.y);
                var deltaWidth = this.offCanvas.width * deltaScale;
                var deltaHeight = this.offCanvas.height * deltaScale;

                var canvasmiddleX = this.canvas.clientWidth / 2;
                var canvasmiddleY = this.canvas.clientHeight / 2;
                var xonmap = (-this.position.x) + canvasmiddleX;
                var yonmap = (-this.position.y) + canvasmiddleY;
                var coefX = -xonmap / (currentWidth);
                var coefY = -yonmap / (currentHeight);
                var newPosX = this.position.x + deltaWidth * coefX;
                var newPosY = this.position.y + deltaHeight * coefY;

                var newWidth = currentWidth + deltaWidth;
                var newHeight = currentHeight + deltaHeight;

                if (newWidth < this.canvas.clientWidth) return;
                if (newPosX > 0) { newPosX = 0; }
                if (newPosX + newWidth < this.canvas.clientWidth) { newPosX = this.canvas.clientWidth - newWidth; }

                if (newHeight < this.canvas.clientHeight) return;
                if (newPosY > 0) { newPosY = 0; }
                if (newPosY + newHeight < this.canvas.clientHeight) { newPosY = this.canvas.clientHeight - newHeight; }

                this.scale.x = newScale;
                this.scale.y = newScale;
                this.position.x = newPosX;
                this.position.y = newPosY;
            },
            //移动
            doMove: function (relativeX, relativeY) {
                if (this.lastX && this.lastY) {
                    var maxX = this.canvas.clientWidth / 3;
                    var maxY = this.canvas.clientHeight / 3;//最多允许拖出宽高1/3
                    var deltaX = relativeX - this.lastX;
                    var deltaY = relativeY - this.lastY;
                    var currentWidth = (this.offCanvas.width * this.scale.x);
                    var currentHeight = (this.offCanvas.height * this.scale.y);

                    this.position.x += deltaX;
                    this.position.y += deltaY;

                    if (this.position.x > maxX) {
                        this.position.x = maxX;
                    }
                    else if (this.position.x + currentWidth + maxX < this.canvas.clientWidth) {
                        this.position.x = this.canvas.clientWidth - currentWidth - maxX;
                    }
                    if (this.position.y > maxY) {
                        this.position.y = maxY;
                    }
                    else if (this.position.y + currentHeight + maxY < this.canvas.clientHeight) {
                        this.position.y = this.canvas.clientHeight - currentHeight - maxY;
                    }
                }

                this.lastX = relativeX;
                this.lastY = relativeY;
            },

            setEventListeners: function () {
                // touch event
                this.canvas.addEventListener('touchstart', function (e) {
                    e.preventDefault();
                    this.lastX = null;
                    this.lastY = null;
                    this.lastZoomScale = null;
                }.bind(this));

                this.canvas.addEventListener('touchmove', function (e) {
                    e.preventDefault();

                    if (e.targetTouches.length == 2) {
                        this.isAnimate = true;
                        this.doZoom(this.gesturePinchZoom(e));
                    }
                    else if (e.targetTouches.length == 1) {
                        this.isAnimate = true;
                        var relativeX = e.targetTouches[0].pageX - this.canvas.getBoundingClientRect().left;
                        var relativeY = e.targetTouches[0].pageY - this.canvas.getBoundingClientRect().top;
                        this.doMove(relativeX, relativeY);
                    }
                }.bind(this));

                this.canvas.addEventListener('touchend', function (e) {
                    e.preventDefault();
                    if (e.changedTouches.length == 1 && !this.isAnimate) {
                        if (this.area_list==null||this.area_list.length == 0) { return; }//没有数据
                        var touch = event.changedTouches[0];
                        var relativeX = touch.pageX - this.canvas.getBoundingClientRect().left;
                        var relativeY = touch.pageY - this.canvas.getBoundingClientRect().top;
                        var pt = {
                            x: relativeX - this.position.x,
                            y: relativeY - this.position.y
                        };
                        var selected_item = null;
                        var selected_index = 0 ;
                        for (var n = 0, ln = this.area_list.length; n < ln; n++) {
                            var area = this.area_list[n];
                            if (!area.state) {
                                //跳出已经不需要验证的数据
                                continue;
                            }

                            var poly = area.points;
                            if (poly == null || poly.length == 0) {
                                //没有坐标数据
                                break;
                            }

                            var c = this.rayCasting(pt, poly, this.scale);
                            if (c != "out") {
                                selected_item = area;
                                selected_index = n;
                                break;
                            }
                        }
                        if (selected_item != null) {
                            var new_item = this.select_index_callback(selected_item);
                            if(new_item){
                                if(selected_item.img_id > -1) {
                                    this.area_list[selected_index] = new_item;
                                    this.offContext.beginPath();
                                    var points = new_item.points;
                                    var pos_x = points[0].x;
                                    var pos_y = points[0].y;
                                    var width = 20;
                                    var height = 20;
                                    this.offContext.clearRect(pos_x, pos_y, width, height);
                                    this.offContext.fillStyle = ColorStrtoRGB(new_item.color);
                                    this.offContext.fillRect(pos_x, pos_y, width, height);
                                    this.offContext.drawImage(this.image_list[new_item.img_id], points[0].x, points[0].y, width, height);
                                    this.offContext.closePath();
                                }
                            }
                        }
                    }
                    if (e.targetTouches.length == 0) {
                        this.isAnimate = false;
                    }
                }.bind(this));

            },

            checkRequestAnimationFrame: function () {
                var lastTime = 0;
                var vendors = ['ms', 'moz', 'webkit', 'o'];
                for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                    window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
                    window.cancelAnimationFrame =
                            window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame'];
                }

                if (!window.requestAnimationFrame) {
                    window.requestAnimationFrame = function (callback, element) {
                        var currTime = new Date().getTime();
                        var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                        var id = window.setTimeout(function () { callback(currTime + timeToCall); },
                                timeToCall);
                        lastTime = currTime + timeToCall;
                        return id;
                    };
                }

                if (!window.cancelAnimationFrame) {
                    window.cancelAnimationFrame = function (id) {
                        clearTimeout(id);
                    };
                }
            },
            rayCasting: function (p, poly, scale) {
                var px = p.x,
                        py = p.y,
                        flag = false;
                for (var i = 0, l = poly.length, j = l - 1; i < l; j = i, i++) {
                    var sx = poly[i].x * scale.x,
                            sy = poly[i].y * scale.y,
                            tx = poly[j].x * scale.x,
                            ty = poly[j].y * scale.y;

                    // 点与多边形顶点重合
                    if ((sx === px && sy === py) || (tx === px && ty === py)) {
                        return 'on';
                    }
                    // 判断线段两端点是否在射线两侧
                    if ((sy < py && ty >= py) || (sy >= py && ty < py)) {
                        // 线段上与射线 Y 坐标相同的点的 X 坐标
                        var x = sx + (py - sy) * (tx - sx) / (ty - sy);
                        // 点在多边形的边上
                        if (x === px) {
                            return 'on';
                        }
                        // 射线穿过多边形的边界
                        if (x > px) {
                            flag = !flag;
                        }
                    }
                }
                // 射线穿过多边形边界的次数为奇数时点在多边形内
                return flag ? 'in' : 'out';
            }
        };

        root.TouchCanvas = TouchCanvas;
    }).call(this);

</script>

<script type="application/javascript">

    var doc = document, win = window;
    var touchCanvas = null;
    var ColorStrtoRGB = function (col) {
        var r = col[0] + col[1];
        var g = col[2] + col[3];
        var b = col[4] + col[5];
        return 'rgba(' + parseInt(r, 16).toString(10) + "," + parseInt(g, 16).toString(10) + "," + parseInt(b, 16).toString(10) + ",0.55)";
    };

    var load_canvas_data = function(canvas_dom_id, bg_img, image_list, area_list, select_index_callback){
        if (touchCanvas) {
            //销毁对象
            if (touchCanvas.area_list) {
                touchCanvas.area_list = null;
            }
            win.cancelAnimationFrame(touchCanvas.animate());
            touchCanvas = null;
        }

        //初始化loading效果
        var canvas = document.getElementById(canvas_dom_id);
        var context = canvas.getContext('2d');
        var w = canvas.width = 500*2;
        var h = canvas.height = 603*2;
        var load = function (image) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, 0, 0, image.width, image.height, (w - image.width) / 2, (h - image.height) / 2, image.width, image.height);
        };
        var li = new Image();
        li.complete = function () {
            load(li);
        };
        li.onload = function () {
            load(li);
        };
        li.src = "http://dui.dmcdn.cn/damai_v2/common/img/logo.png";


        var width = 500*2;
        var height = 603*2;
        var boxMaxWidth = 0;
        var boxMaxHeight = 0;

        for (var i = 0, ai = area_list.length; i < ai; i++) {
            var area = area_list[i];
            var x = area.points[0].x + 20 | 0;
            var y = area.points[0].y + 20 | 0;
            boxMaxWidth = x > boxMaxWidth ? x : boxMaxWidth;
            boxMaxHeight = y > boxMaxHeight ? y : boxMaxHeight;
        }
        touchCanvas = new TouchCanvas({
            canvas: document.getElementById(canvas_dom_id),
            width: width,
            height: height,
            boxMaxWidth: boxMaxWidth,
            boxMaxHeight: boxMaxHeight,
            area_list: area_list,
            image_list: image_list,
            bg_img: bg_img,
            select_index_callback: select_index_callback
        });
    };

    var load_seat_data = function(canvas_dom_id, image_list, area_list){
        load_canvas_data(canvas_dom_id, undefined, image_list, area_list, function(item){
            var select_state = seat_states[3];
            if(item.img_id == 3) {
                select_state = seat_states[1];
                item.state = select_state.state;
                item.img_id = select_state.image;
                item.color = select_state.color;
                console.log(item);
                return item
            }
            item.state = select_state.state;
            item.img_id = select_state.image;
            item.color = select_state.color;
            console.log(item);
            return item;
        });
    };

    var load_area_data = function(canvas_dom_id, area_list, bg_img){
        load_canvas_data(canvas_dom_id, bg_img, [], area_list, function(item){
            enter_area(item);
        });
    };


    var get_area_list = function() {
        var id = 1;
        var area_list = [];

        // 	0：空，1：可售，2：锁定，3：选中（网页用）
        for (var i = 0; i < 50; i++) {
            for (var j = 0; j < 10; j++) {
                var seat_state = seat_states[(i*j) % 4];
                var area ={};
                area['id'] = id++;
                area['state'] = seat_state.state;
                area['img_id'] = seat_state.image;
                area['color'] = seat_state.color;
                area['points'] = [
                    {'x':i * 25,      'y': j * 25},
                    {'x':i * 25 + 20, 'y': j * 25},
                    {'x':i * 25 + 20, 'y': j * 25 + 20},
                    {'x':i * 25,      'y': j * 25 + 20}
                ];

                area_list.push(area);
            }
        }
        return area_list;
    };


    var load_images = function(sources, callback) {
        var image_list = [];
        for (var i = 0; i < sources.length; i++){
            image_list.push(0);
        }
        var has_loaded = false;
        var check_zero = function(list) {
            return list.filter(function (item) {return item === 0;}).length == 0
        };

        sources && sources.forEach(function (src, index) {
            var img = new Image();
            img.src = src;
            if (img.complete) {
                image_list[index] = img;
                if (!has_loaded && check_zero(image_list)) {
                    has_loaded = true;
                    callback(image_list);
                    return;
                }
            }
            img.onload = function () {
                image_list[index] = img;
                if (!has_loaded && check_zero(image_list)) {
                    has_loaded = true;
                    callback(image_list);
                }
                img.onload = null;
            };
            img.onerror = function () {
                alert('资源加载失败！')
            };
        });
    }

    var enter_area = function(area){
        var area_list = get_area_list(area);
        //0:背景, 1:可售, 2:锁定, 3:选中, 4:套票
        load_images([
            'http://m.damai.cn/images/seat/bg.png',
            'http://m.damai.cn/images/seat/sold.png',
            'http://m.damai.cn/images/seat/seat_lock@3x.png',
            'http://m.damai.cn/images/seat/selected.png',
            'http://m.damai.cn/images/seat/double.png'
        ], function(image_list){
            load_seat_data("onlineSeatZone", image_list, area_list);
        });
    };

    var jsonData = {"t":null,"cid":872,"ver":7,"pid":8530247,"msq":[{"c":"F91616","n":"A","i":"489929","s":"1","pis":"185,96|158,105|154,134|142,161|125,181|124,210|126,248|123,304|216,295|305,294|375,305|371,257|373,213|373,182|356,161|344,136|340,107|311,94","j":"93982,93983,94217","u":"cid=872&id=81044&kid=489929&limit=6&orderid=0&pid=8530247&ver=7&_m=5b7040bea2661751e63d61f94b45eace"},{"c":"80FF80","n":"B","i":"489930","s":"2","pis":"376,55|359,80|353,99|353,122|362,148|367,163|381,172|424,120|407,96|389,72","j":"94217","u":"cid=872&id=81044&kid=489930&limit=6&orderid=0&pid=8530247&ver=7&_m=570f5676b33ee9f200470998ca3a711e"},{"c":"EEB31B","n":"C","i":"489931","s":"1","pis":"436,142|409,171|390,205|380,236|380,271|391,318|394,344|398,373|407,386|442,367|470,351|491,329|465,257|459,204|463,169","j":"93984,94217","u":"cid=872&id=81044&kid=489931&limit=6&orderid=0&pid=8530247&ver=7&_m=1985121536ad90d04a49cc4b0d98ba2b"},{"c":"80FF80","n":"D","i":"489932","s":"2","pis":"463,368|436,383|414,406|401,426|388,445|375,472|361,499|358,517|386,530|401,525|436,493|453,463|460,437|464,402","j":"94217","u":"cid=872&id=81044&kid=489932&limit=6&orderid=0&pid=8530247&ver=7&_m=86cbe7e0748fbbcbd1da5ace212610dd"},{"c":"80FF80","n":"E","i":"489933","s":"2","pis":"171,491|172,523|184,539|154,552|162,570|182,581|209,562|219,555|254,558|286,555|314,582|339,570|349,552|322,543|334,525|336,492|262,491","j":"94217","u":"cid=872&id=81044&kid=489933&limit=6&orderid=0&pid=8530247&ver=7&_m=3abc7482cf97b892da3a0fcfb1e18c14"},{"c":"EEB31B","n":"F","i":"489934","s":"1","pis":"110,445|95,428|83,406|72,396|62,381|53,375|35,366|31,404|37,440|47,467|61,494|98,527|118,530|135,522|143,513|138,500|126,475","j":"93984,94217","u":"cid=872&id=81044&kid=489934&limit=6&orderid=0&pid=8530247&ver=7&_m=20b203a28782e0f2beff01530e9c48db"},{"c":"355fac","n":"G","i":"489935","s":"1","pis":"107,319|116,289|115,260|115,226|105,194|87,172|64,142|36,166|40,204|44,237|33,256|15,289|5,330|26,354|53,365|87,387|97,369|105,345","j":"93984,93987,94217","u":"cid=872&id=81044&kid=489935&limit=6&orderid=0&pid=8530247&ver=7&_m=2dfc0fd0a7eb80db0d42dc09bd0fb675"},{"c":"80FF80","n":"H","i":"489936","s":"2","pis":"144,133|147,109|141,81|125,54|114,59|91,99|76,119|116,170|133,161|138,148","j":"94217","u":"cid=872&id=81044&kid=489936&limit=6&orderid=0&pid=8530247&ver=7&_m=77cf5222c1e9cfe568c3a25328bf9bd3"},{"c":"80FF80","n":"I","i":"489937","s":"2","pis":"211,15|203,26|174,33|183,77|250,75|317,77|325,34|291,25|284,16|250,13","j":"94217","u":"cid=872&id=81044&kid=489937&limit=6&orderid=0&pid=8530247&ver=7&_m=e9a9831f7d28e9a5dfbe6861b2c10cb7"}],"seatimg":"http://sseat.damai.cn/Resources/xuanzuo/StandImage/872/8530247/performbg.jpg","lc":[{"p":"580","c":"F91616"},{"p":"380","c":"EF8686"},{"p":"280","c":"355fac"},{"p":"180","c":"EEB31B"},{"p":"120","c":"8ac4e3"},{"p":"80","c":"bf6aa2"}],"p":{"i":8530247,"isxz":true,"l":[{"buyNowSum":20,"i":10764438,"n":"80","p":80,"s":1,"t":false},{"buyNowSum":20,"i":10764437,"n":"120","p":120,"s":1,"t":false},{"buyNowSum":20,"i":10764436,"n":"180","p":180,"s":0,"t":false},{"buyNowSum":20,"i":10778314,"n":"280","p":280,"s":0,"t":false},{"buyNowSum":20,"i":10764435,"n":"380","p":380,"s":0,"t":false},{"buyNowSum":20,"i":10764434,"n":"580","p":580,"s":0,"t":false}],"lsum":20,"n":"2015-12-12 周六 19:30","sum":6,"t":"2015-12-12T11:30:00Z","timetemp":"2015-12-12 19:30:00","u":null}};
    var areas = jsonData['msq'];
    var area_list = [];
    for (var i = 0, ai = areas.length; i < ai; i++) {
        var area = areas[i];
        var points = area["pis"].split("|");
        var pos = [];
        for (var r = 0, ar = points.length; r < ar; r++) // 遍历画图闭合线坐标
        {
            var point = points[r].split(","); // 拆分点标
            var x = point[0] | 0;
            var y = point[1] | 0;
            pos.push({ x: x, y: y });
        }
        area_list.push({
            color: area.c,
            state: area.s != 2,
            points: pos,
            img_id: -1
        });
    }
    load_area_data("onlineSeatZone", area_list, jsonData.seatimg);


</script>

</body>
</html>